<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARAGRAPHS</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier Prime', monospace;
            background: #ffffff;
            color: #000000;
            line-height: 1.4;
            overflow-x: hidden;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .container {
            height: 100vh;
            padding: 0;
            margin: 0;
            position: relative;
        }
        
        /* Main menu layout */
        .main-menu-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .main-menu-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .main-menu-controls {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #000;
            background: #fff;
        }

        /* Game Room Full-Screen Layout */
        .game-room-layout {
            height: 100vh;
            display: grid;
            grid-template-areas: 
                "room-info . scoreboard"
                "participants center-content phase-status"
                "controls center-content controls-right";
            grid-template-columns: 280px 1fr 280px;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            padding: 20px;
            box-sizing: border-box;
        }
        
        /* Room Info - Top Left */
        .room-info-panel {
            grid-area: room-info;
            border: 2px solid #000;
            padding: 15px;
            background: #fff;
            font-size: 14px;
            height: fit-content;
            font-weight: bold;
        }
        
        /* Scoreboard - Top Right */
        .scoreboard-panel {
            grid-area: scoreboard;
            border: 2px solid #000;
            padding: 15px;
            background: #fff;
            height: fit-content;
            font-size: 14px;
        }
        
        /* Participants - Left Side */
        .participants-panel {
            grid-area: participants;
            border: 2px solid #000;
            padding: 15px;
            background: #fff;
            align-self: start;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
        }
        
        /* Center Content Area */
        .center-content {
            grid-area: center-content;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0 20px;
            position: relative;
        }
        
        /* Phase Status - Right Side */
        .phase-status-panel {
            grid-area: phase-status;
            border: 2px solid #000;
            padding: 15px;
            background: #fff;
            align-self: start;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            line-height: 1.4;
        }
        
        /* Controls - Bottom */
        .controls-panel {
            grid-area: controls;
            text-align: left;
            padding: 10px 0;
        }
        
        .controls-right-panel {
            grid-area: controls-right;
            text-align: right;
            padding: 10px 0;
        }
        
        /* Main Paragraph Display */
        .main-paragraph {
            border: 4px solid #000;
            background: #fff;
            padding: 40px;
            margin-bottom: 40px;
            min-height: 180px;
            width: 100%;
            max-width: 800px;
            font-size: 20px;
            line-height: 1.8;
            position: relative;
            background-image: 
                repeating-linear-gradient(
                    transparent,
                    transparent 32px,
                    #000 32px,
                    #000 33px
                );
            background-attachment: local;
        }
        
        .main-paragraph::after {
            content: '';
            display: inline-block;
            width: 3px;
            height: 24px;
            background: #000;
            animation: blink 1s infinite;
            margin-left: 3px;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Writing Area */
        .main-writing-area {
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
        }
        
        .main-text-input {
            width: 100%;
            padding: 25px;
            border: 4px solid #000;
            font-family: inherit;
            font-size: 18px;
            background: #fff;
            resize: none;
            min-height: 120px;
            line-height: 1.6;
        }
        
        .main-text-input:focus {
            outline: none;
            box-shadow: inset 4px 4px 0px #000;
        }
        
        /* Voting Options - Large Center Display */
        .main-voting-options {
            width: 100%;
            max-width: 800px;
            margin: 20px 0;
        }
        
        .main-option {
            border: 4px solid #000;
            padding: 25px;
            margin: 20px 0;
            cursor: pointer;
            position: relative;
            font-size: 18px;
            line-height: 1.6;
            background: #fff;
        }
        
        .main-option:hover {
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 3px,
                    #000 3px,
                    #000 4px
                );
            opacity: 0.08;
        }
        
        .main-option.selected {
            background: #000;
            color: #fff;
        }
        
        .main-option-label {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 16px;
            opacity: 0.7;
        }
        
        .main-vote-count {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 14px;
            background: #fff;
            color: #000;
            padding: 6px 12px;
            border: 2px solid #000;
            font-weight: bold;
        }
        
        .main-option.selected .main-vote-count {
            background: #000;
            color: #fff;
            border-color: #fff;
        }
        
        /* Big Action Button */
        .big-btn {
            background: #000;
            color: #fff;
            border: 4px solid #000;
            padding: 18px 36px;
            font-family: inherit;
            font-size: 18px;
            cursor: pointer;
            margin: 15px 0;
            text-decoration: none;
            display: inline-block;
            transition: all 0.1s;
            font-weight: bold;
        }
        
        .big-btn:hover {
            background: #fff;
            color: #000;
        }
        
        .big-btn:active {
            transform: translate(2px, 2px);
        }
        
        /* Compact Participants List */
        .participants-list-compact {
            font-size: 13px;
        }
        
        .participant-compact {
            display: block;
            margin: 6px 0;
            padding: 6px 10px;
            border: 2px solid #000;
            font-size: 12px;
        }
        
        .participant-compact.ready {
            background: #000;
            color: #fff;
        }
        
        .participant-compact.current-player {
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    #000 2px,
                    #000 3px
                );
            background-size: 6px 6px;
            opacity: 0.15;
        }
        
        /* Pinterest-style grid for paragraphs */
        .paragraphs-grid {
            columns: 3;
            column-gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 1200px) {
            .game-room-layout {
                grid-template-columns: 240px 1fr 240px;
                gap: 15px;
                padding: 15px;
            }
            
            .main-paragraph {
                font-size: 18px;
                padding: 30px;
            }
            
            .main-text-input {
                font-size: 16px;
                padding: 20px;
            }
            
            .main-option {
                font-size: 16px;
                padding: 20px;
            }
        }
        
        @media (max-width: 900px) {
            .paragraphs-grid {
                columns: 2;
            }
            
            .game-room-layout {
                grid-template-areas: 
                    "room-info scoreboard"
                    "center-content center-content"
                    "participants phase-status"
                    "controls controls-right";
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto 1fr auto auto;
            }
            
            .participants-panel,
            .phase-status-panel {
                max-height: 200px;
            }
        }
        
        @media (max-width: 600px) {
            .paragraphs-grid {
                columns: 1;
            }
            
            .game-room-layout {
                grid-template-areas: 
                    "room-info"
                    "scoreboard"
                    "center-content"
                    "participants"
                    "phase-status"
                    "controls";
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto auto auto;
                gap: 10px;
                padding: 10px;
            }
            
            .controls-right-panel {
                display: none;
            }
            
            .main-paragraph {
                font-size: 16px;
                padding: 20px;
                min-height: 120px;
            }
            
            .main-text-input {
                font-size: 14px;
                padding: 15px;
                min-height: 80px;
            }
            
            .main-option {
                font-size: 14px;
                padding: 15px;
                margin: 10px 0;
            }
        }
        
        .paragraph-card {
            border: 2px solid #000;
            margin-bottom: 20px;
            padding: 15px;
            background: #fff;
            break-inside: avoid;
            page-break-inside: avoid;
        }
        
        .paragraph-card:hover {
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    #000 2px,
                    #000 3px
                );
            background-size: 8px 8px;
            opacity: 0.03;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            border: 2px solid #000;
            padding: 20px;
            background: 
                radial-gradient(circle at 25% 25%, #000 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, #000 1px, transparent 1px);
            background-size: 4px 4px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .btn {
            background: #000;
            color: #fff;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.1s;
        }
        
        .btn:hover {
            background: #fff;
            color: #000;
        }
        
        .btn:active {
            transform: translate(1px, 1px);
        }
        
        .room-info {
            border: 2px solid #000;
            padding: 15px;
            margin-bottom: 20px;
            background: #fff;
        }
        
        .paragraph-box {
            border: 2px solid #000;
            padding: 20px;
            margin: 20px 0;
            min-height: 150px;
            background: #fff;
        }
        
        .paragraph-text {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .phase-indicator {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #000;
        }
        
        .phase-writing {
            background: 
                radial-gradient(circle, #000 25%, transparent 25%),
                radial-gradient(circle, #000 25%, transparent 25%);
            background-size: 4px 4px;
            background-position: 0 0, 2px 2px;
            opacity: 0.1;
        }
        
        .phase-voting {
            background: 
                linear-gradient(45deg, #000 25%, transparent 25%),
                linear-gradient(-45deg, #000 25%, transparent 25%);
            background-size: 6px 6px;
            opacity: 0.1;
        }
        
        .input-area {
            margin: 20px 0;
        }
        
        .text-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #000;
            font-family: inherit;
            font-size: 14px;
            background: #fff;
            resize: none;
            min-height: 80px;
        }
        
        .text-input:focus {
            outline: none;
            box-shadow: inset 2px 2px 0px #000;
        }
        
        .participants {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #000;
        }
        
        .participant {
            display: inline-block;
            margin: 2px 5px;
            padding: 2px 8px;
            border: 1px solid #000;
            font-size: 12px;
        }
        
        .participant.ready {
            background: #000;
            color: #fff;
        }
        
        .participant.current-player {
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 1px,
                    #000 1px,
                    #000 2px
                );
            background-size: 4px 4px;
            opacity: 0.2;
        }
        
        .voting-options {
            margin: 20px 0;
        }
        
        .option {
            border: 2px solid #000;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            position: relative;
        }
        
        .option:hover {
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 2px,
                    #000 2px,
                    #000 3px
                );
            opacity: 0.1;
        }
        
        .option.selected {
            background: #000;
            color: #fff;
        }
        
        .option-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .vote-count {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 12px;
            background: #fff;
            color: #000;
            padding: 2px 6px;
            border: 1px solid #000;
        }
        
        .hidden {
            display: none;
        }
        
        .room-settings {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #000;
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 1px,
                    #000 1px,
                    #000 2px
                );
            background-size: 10px 10px;
            opacity: 0.05;
        }
        
        .settings-row {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .toggle {
            width: 40px;
            height: 20px;
            border: 2px solid #000;
            background: #fff;
            position: relative;
            cursor: pointer;
        }
        
        .toggle.on {
            background: #000;
        }
        
        .toggle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #000;
            top: 0px;
            left: 0px;
            transition: left 0.2s;
        }
        
        .toggle.on::after {
            background: #fff;
            left: 20px;
        }
        
        .scoreboard-title {
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
        }
        
        .score-item {
            margin: 5px 0;
            padding: 3px 0;
        }
        
        .completed-paragraph {
            border: 1px solid #000;
            margin: 10px 0;
            padding: 15px;
            background: #fff;
        }
        
        .paragraph-header {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #000;
        }
        
        .paragraph-contributors {
            font-size: 12px;
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px solid #000;
            opacity: 0.7;
        }
        
        .no-paragraphs {
            text-align: center;
            font-style: italic;
            opacity: 0.7;
            padding: 20px;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border: 1px solid #000;
            background: #fff;
            font-size: 12px;
            z-index: 1000;
        }

        .connection-status.connected {
            background: #000;
            color: #fff;
        }
        
        /* Hide old layout elements in game room */
        #game-room .room-info,
        #game-room .paragraph-box,
        #game-room .phase-indicator,
        #game-room .participants,
        #game-room #scoreboard {
            display: none;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">Connecting...</div>
    
    <div class="container">
        <!-- Main Menu -->
        <div id="main-menu" class="screen">
            <div class="main-menu-container">
                <div class="main-menu-header">
                    <div class="header">
                        <div class="logo">P A R A G R A P H S</div>
                        <div class="subtitle">Collaborative Writing Tool</div>
                    </div>
                </div>
                
                <div class="main-menu-controls">
                    <button class="btn" onclick="createRoom()">CREATE ROOM</button>
                    <input type="text" id="room-code" placeholder="Enter room code..." style="margin: 10px; padding: 8px; border: 2px solid #000; font-family: inherit;">
                    <button class="btn" onclick="joinRoom()">JOIN ROOM</button>
                </div>
                
                <div style="flex-grow: 1;">
                    <div style="text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #000; padding-bottom: 10px;">COMPLETED PARAGRAPHS</div>
                    <div id="completed-paragraphs" class="paragraphs-grid">
                        <!-- Completed paragraphs will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Room Setup -->
        <div id="room-setup" class="screen hidden">
            <div style="max-width: 600px; margin: 0 auto; padding: 40px 20px;">
                <div class="header">
                    <div class="logo">ROOM SETUP</div>
                </div>
                
                <div class="room-settings">
                    <div class="settings-row">
                        <span>Mode:</span>
                        <select id="mode-select" style="border: 2px solid #000; padding: 5px; font-family: inherit;">
                            <option value="quick">Quick (5 sentences)</option>
                            <option value="standard" selected>Standard (10 sentences)</option>
                            <option value="epic">Epic (20 sentences)</option>
                        </select>
                    </div>
                    
                    <div class="settings-row">
                        <span>Anonymous mode:</span>
                        <div class="toggle" onclick="toggleAnonymous()"></div>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <input type="text" id="player-name" placeholder="Enter your name..." style="width: 100%; padding: 10px; border: 2px solid #000; font-family: inherit; margin-bottom: 10px;">
                    <div style="text-align: center;">
                        <button class="btn" onclick="startRoom()">JOIN ROOM</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Room -->
        <div id="game-room" class="screen hidden">
            <div class="game-room-layout">
                <!-- Room Info - Top Left -->
                <div class="room-info-panel">
                    <div>ROOM: <span id="room-id">XXXX</span></div>
                    <div>ROUND: <span id="round-number">1</span>/<span id="max-rounds">10</span></div>
                </div>
                
                <!-- Scoreboard - Top Right -->
                <div class="scoreboard-panel" id="scoreboard-main">
                    <div style="font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">SCOREBOARD</div>
                </div>
                
                <!-- Participants - Left Side -->
                <div class="participants-panel">
                    <div style="font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">PARTICIPANTS (<span id="participant-count">1</span>)</div>
                    <div id="participants-list-main" class="participants-list-compact">
                        <!-- Participants will be shown here -->
                    </div>
                </div>
                
                <!-- Phase Status - Right Side -->
                <div class="phase-status-panel" id="phase-indicator-main">
                    Share room code with participants. Need at least 3 people to start.
                </div>
                
                <!-- Center Content -->
                <div class="center-content">
                    <!-- Main Paragraph Display -->
                    <div class="main-paragraph" id="current-paragraph-main">
                        Share room code with participants. Need at least 3 people to start.
                    </div>
                    
                    <!-- Writing Phase -->
                    <div id="writing-phase-main" class="main-writing-area hidden">
                        <textarea class="main-text-input" id="sentence-input-main" placeholder="Write the next sentence..."></textarea>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="big-btn" onclick="submitSentence()">SUBMIT SENTENCE</button>
                        </div>
                    </div>
                    
                    <!-- Voting Phase -->
                    <div id="voting-phase-main" class="main-voting-options hidden">
                        <!-- Options will be populated here -->
                    </div>
                </div>
                
                <!-- Controls - Bottom Left -->
                <div class="controls-panel">
                    <button class="btn" id="start-btn-main" onclick="startWriting()" style="display: none;">START WRITING</button>
                    <button class="btn" onclick="leaveRoom()">LEAVE ROOM</button>
                </div>
                
                <!-- Controls Right - Bottom Right -->
                <div class="controls-right-panel">
                    <!-- Additional controls can go here -->
                </div>
            </div>
            
            <!-- Hidden old elements for compatibility -->
            <div class="room-info" style="display: none;">
                <strong>Room: <span id="room-id-old">XXXX</span></strong> | 
                Participants: <span id="participant-count-old">1</span> | 
                Round: <span id="round-number-old">1</span>/<span id="max-rounds-old">10</span>
            </div>
            
            <div class="paragraph-box" style="display: none;">
                <div class="paragraph-text" id="current-paragraph">
                    Share room code with participants. Need at least 3 people to start.
                </div>
            </div>
            
            <div class="phase-indicator" id="phase-indicator" style="display: none;">
                Share room code with participants. Need at least 3 people to start.
            </div>
            
            <div class="participants" id="participants-list" style="display: none;">
                <!-- Participants will be shown here -->
            </div>
            
            <div id="scoreboard" style="display: none; margin: 15px 0; padding: 10px; border: 1px solid #000; background: #fff;">
                <div class="scoreboard-title">SCOREBOARD</div>
            </div>
            
            <!-- Writing Phase -->
            <div id="writing-phase" class="input-area hidden" style="display: none;">
                <textarea class="text-input" id="sentence-input" placeholder="Write the next sentence..."></textarea>
                <div style="text-align: center; margin-top: 10px;">
                    <button class="btn" onclick="submitSentence()">SUBMIT</button>
                </div>
            </div>
            
            <!-- Voting Phase -->
            <div id="voting-phase" class="hidden" style="display: none;">
                <div class="voting-options" id="voting-options">
                    <!-- Options will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database-compat.min.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCq0zaZKpWj1cWmiu-pqiHo4MuLmA9xZkc",
            authDomain: "paragraphs-e9d60.firebaseapp.com",
            databaseURL: "https://paragraphs-e9d60-default-rtdb.firebaseio.com/",
            projectId: "paragraphs-e9d60",
            storageBucket: "paragraphs-e9d60.firebasestorage.app",
            messagingSenderId: "116355067615",
            appId: "1:116355067615:web:52288095ad38472545836a",
            measurementId: "G-FHQWN8GYML"
        };

        // Initialize Firebase
        let db;
        let connected = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            
            // Connection status
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', (snapshot) => {
                connected = snapshot.val();
                const statusEl = document.getElementById('connection-status');
                if (connected) {
                    statusEl.textContent = 'Connected';
                    statusEl.classList.add('connected');
                } else {
                    statusEl.textContent = 'Disconnected';
                    statusEl.classList.remove('connected');
                }
            });
        } catch (error) {
            document.getElementById('connection-status').textContent = 'Error';
        }

        // Game state
        let gameState = {
            roomId: null,
            playerName: '',
            currentPhase: 'waiting',
            participants: [],
            currentParagraph: '',
            sentences: [],
            votingOptions: [],
            selectedOption: null,
            round: 1,
            maxRounds: 10,
            anonymousMode: false,
            scores: {},
            submittedSentences: new Set(),
            votedParticipants: new Set(),
            isHost: false
        };

        let roomRef = null;
        let completedParagraphs = JSON.parse(localStorage.getItem('paragraphs') || '[]');

        // Utility functions
        function generateRoomId() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function updateUI() {
            // Update room info
            document.getElementById('room-id').textContent = gameState.roomId || 'XXXX';
            document.getElementById('participant-count').textContent = gameState.participants.length;
            document.getElementById('round-number').textContent = gameState.round;
            document.getElementById('max-rounds').textContent = gameState.maxRounds;
            document.getElementById('current-paragraph').textContent = gameState.currentParagraph || 'Share room code with participants. Need at least 3 people to start.';
            
            // Update new main elements
            const currentParagraphMain = document.getElementById('current-paragraph-main');
            if (currentParagraphMain) {
                currentParagraphMain.textContent = gameState.currentParagraph || 'Share room code with participants. Need at least 3 people to start.';
            }
            
            // Update participants list (old)
            const participantsList = document.getElementById('participants-list');
            if (participantsList) {
                participantsList.innerHTML = gameState.participants.map(p => {
                    const hasSubmitted = gameState.submittedSentences.has(p);
                    const isCurrentPlayer = p === gameState.playerName;
                    return `<div class="participant${hasSubmitted ? ' ready' : ''}${isCurrentPlayer ? ' current-player' : ''}">${p}</div>`;
                }).join('');
            }
            
            // Update participants list (new)
            const participantsListMain = document.getElementById('participants-list-main');
            if (participantsListMain) {
                participantsListMain.innerHTML = gameState.participants.map(p => {
                    const hasSubmitted = gameState.submittedSentences.has(p);
                    const isCurrentPlayer = p === gameState.playerName;
                    return `<div class="participant-compact${hasSubmitted ? ' ready' : ''}${isCurrentPlayer ? ' current-player' : ''}">${p}</div>`;
                }).join('');
            }
            
            // Update phase indicator and start button
            const startBtn = document.getElementById('start-btn');
            const startBtnMain = document.getElementById('start-btn-main');
            const phaseIndicator = document.getElementById('phase-indicator');
            const phaseIndicatorMain = document.getElementById('phase-indicator-main');
            
            let phaseText = '';
            let showStartBtn = false;
            
            if (gameState.currentPhase === 'waiting') {
                if (gameState.participants.length < 3) {
                    phaseText = `Share room code: ${gameState.roomId} - Need ${3 - gameState.participants.length} more participant(s) (minimum 3)`;
                    showStartBtn = false;
                } else if (gameState.isHost) {
                    phaseText = `${gameState.participants.length} participants ready. Click START WRITING when ready.`;
                    showStartBtn = true;
                } else {
                    phaseText = `Waiting for host to start the game...`;
                    showStartBtn = false;
                }
            } else {
                showStartBtn = false;
            }
            
            if (phaseIndicator) phaseIndicator.textContent = phaseText;
            if (phaseIndicatorMain) phaseIndicatorMain.textContent = phaseText;
            
            if (startBtn) startBtn.style.display = showStartBtn ? 'inline-block' : 'none';
            if (startBtnMain) startBtnMain.style.display = showStartBtn ? 'inline-block' : 'none';
        }

        function updateScoreboard() {
            const scoreboardHtml = Object.entries(gameState.scores || {})
                .sort(([,a], [,b]) => b - a)
                .map(([player, score]) => `<div class="score-item">${player}: ${score} votes</div>`)
                .join('');
            
            // Update old scoreboard
            const existingScoreboard = document.getElementById('scoreboard');
            if (existingScoreboard) {
                existingScoreboard.innerHTML = `
                    <div class="scoreboard-title">SCOREBOARD</div>
                    ${scoreboardHtml}
                `;
            }
            
            // Update new main scoreboard
            const mainScoreboard = document.getElementById('scoreboard-main');
            if (mainScoreboard) {
                mainScoreboard.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">SCOREBOARD</div>
                    ${scoreboardHtml}
                `;
            }
        }

        function updateGamePhaseUI() {
            if (gameState.currentPhase === 'writing') {
                // Show writing phase (old)
                document.getElementById('writing-phase').classList.remove('hidden');
                document.getElementById('voting-phase').classList.add('hidden');
                
                // Show writing phase (new)
                const writingPhaseMain = document.getElementById('writing-phase-main');
                const votingPhaseMain = document.getElementById('voting-phase-main');
                if (writingPhaseMain) writingPhaseMain.classList.remove('hidden');
                if (votingPhaseMain) votingPhaseMain.classList.add('hidden');
                
                // Update phase indicators
                const phaseIndicators = [document.getElementById('phase-indicator'), document.getElementById('phase-indicator-main')];
                phaseIndicators.forEach(indicator => {
                    if (indicator) {
                        indicator.className = indicator.className.replace(/phase-\w+/g, '') + ' phase-writing';
                        indicator.textContent = `Round ${gameState.round}: Write the next sentence`;
                    }
                });
                
                // Focus on the new input
                const sentenceInputMain = document.getElementById('sentence-input-main');
                if (sentenceInputMain) sentenceInputMain.focus();
                
            } else if (gameState.currentPhase === 'voting') {
                // Hide writing phase (old)
                document.getElementById('writing-phase').classList.add('hidden');
                document.getElementById('voting-phase').classList.remove('hidden');
                
                // Hide writing phase (new)
                const writingPhaseMain = document.getElementById('writing-phase-main');
                const votingPhaseMain = document.getElementById('voting-phase-main');
                if (writingPhaseMain) writingPhaseMain.classList.add('hidden');
                if (votingPhaseMain) votingPhaseMain.classList.remove('hidden');
                
                // Update phase indicators
                const phaseIndicators = [document.getElementById('phase-indicator'), document.getElementById('phase-indicator-main')];
                phaseIndicators.forEach(indicator => {
                    if (indicator) {
                        indicator.className = indicator.className.replace(/phase-\w+/g, '') + ' phase-voting';
                        indicator.textContent = 'Vote for the best sentence';
                    }
                });
                
                // Rebuild voting options (old)
                const votingContainer = document.getElementById('voting-options');
                if (gameState.votingOptions && gameState.votingOptions.length > 0 && votingContainer) {
                    votingContainer.innerHTML = gameState.votingOptions.map((option, index) => `
                        <div class="option${gameState.selectedOption === index ? ' selected' : ''}" onclick="voteForOption(${index})">
                            <div class="option-label">Option ${String.fromCharCode(65 + index)}</div>
                            <div>${option.text}</div>
                            <div class="vote-count" id="vote-count-${index}">${option.votes || 0} votes</div>
                        </div>
                    `).join('');
                }
                
                // Rebuild voting options (new)
                if (gameState.votingOptions && gameState.votingOptions.length > 0 && votingPhaseMain) {
                    votingPhaseMain.innerHTML = gameState.votingOptions.map((option, index) => `
                        <div class="main-option${gameState.selectedOption === index ? ' selected' : ''}" onclick="voteForOption(${index})">
                            <div class="main-option-label">Option ${String.fromCharCode(65 + index)}</div>
                            <div>${option.text}</div>
                            <div class="main-vote-count" id="main-vote-count-${index}">${option.votes || 0} votes</div>
                        </div>
                    `).join('');
                }
                
            } else {
                // Hide both phases
                document.getElementById('writing-phase').classList.add('hidden');
                document.getElementById('voting-phase').classList.add('hidden');
                
                const writingPhaseMain = document.getElementById('writing-phase-main');
                const votingPhaseMain = document.getElementById('voting-phase-main');
                if (writingPhaseMain) writingPhaseMain.classList.add('hidden');
                if (votingPhaseMain) votingPhaseMain.classList.add('hidden');
            }
        }

        function saveRoomState() {
            if (!db || !gameState.roomId) return;
            
            const roomData = {
                ...gameState,
                submittedSentences: Array.from(gameState.submittedSentences),
                votedParticipants: Array.from(gameState.votedParticipants),
                lastUpdate: Date.now()
            };
            
            db.ref('rooms/' + gameState.roomId).set(roomData).catch(error => {
                // Silent error handling
            });
        }

        function listenToRoom(roomId) {
            if (!db) return;
            
            roomRef = db.ref('rooms/' + roomId);
            roomRef.on('value', (snapshot) => {
                const roomData = snapshot.val();
                if (roomData) {
                    const wasHost = gameState.isHost;
                    const playerName = gameState.playerName;
                    const currentSelectedOption = gameState.selectedOption;
                    
                    gameState = {
                        ...roomData,
                        submittedSentences: new Set(roomData.submittedSentences || []),
                        votedParticipants: new Set(roomData.votedParticipants || []),
                        isHost: wasHost,
                        playerName: playerName,
                        selectedOption: gameState.votedParticipants.has(playerName) ? currentSelectedOption : null
                    };
                    
                    updateUI();
                    updateScoreboard();
                    updateGamePhaseUI();
                }
            });
        }

        function displayCompletedParagraphs() {
            const container = document.getElementById('completed-paragraphs');
            if (completedParagraphs.length === 0) {
                container.innerHTML = '<div class="no-paragraphs">No paragraphs completed yet. Create a room to start writing!</div>';
                return;
            }
            
            container.innerHTML = completedParagraphs
                .slice()
                .reverse()
                .map((para, index) => `
                    <div class="paragraph-card">
                        <div class="paragraph-header">
                            #${completedParagraphs.length - index} | ${para.roomId}
                        </div>
                        <div style="font-size: 14px; line-height: 1.5; margin: 10px 0;">${para.text}</div>
                        <div class="paragraph-contributors">
                            ${para.timestamp}<br>
                            ${para.contributors.join(', ')}
                        </div>
                    </div>
                `).join('');
        }

        function loadCompletedParagraphs() {
            if (!db) {
                displayCompletedParagraphs();
                return;
            }
            
            db.ref('completedParagraphs').once('value').then((snapshot) => {
                const firebaseParagraphs = snapshot.val();
                if (firebaseParagraphs) {
                    // Convert Firebase object to array and sort by timestamp
                    const paragraphsArray = Object.values(firebaseParagraphs)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    // Merge with local storage (remove duplicates by ID)
                    const localParagraphs = JSON.parse(localStorage.getItem('paragraphs') || '[]');
                    const allParagraphs = [...paragraphsArray];
                    
                    // Add local paragraphs that aren't in Firebase yet
                    localParagraphs.forEach(localPara => {
                        if (!paragraphsArray.find(fbPara => fbPara.id === localPara.id)) {
                            allParagraphs.push(localPara);
                        }
                    });
                    
                    completedParagraphs = allParagraphs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    // Update local storage with merged data
                    localStorage.setItem('paragraphs', JSON.stringify(completedParagraphs));
                } else {
                    // No paragraphs in Firebase, use local storage
                    completedParagraphs = JSON.parse(localStorage.getItem('paragraphs') || '[]');
                }
                
                displayCompletedParagraphs();
            }).catch(error => {
                // Fallback to local storage
                completedParagraphs = JSON.parse(localStorage.getItem('paragraphs') || '[]');
                displayCompletedParagraphs();
            });
        }

        // Main functions
        function createRoom() {
            gameState.roomId = generateRoomId();
            gameState.isHost = true;
            showScreen('room-setup');
        }

        function joinRoom() {
            const roomCode = document.getElementById('room-code').value.toUpperCase();
            if (roomCode.length === 4) {
                if (db) {
                    db.ref('rooms/' + roomCode).once('value').then((snapshot) => {
                        if (snapshot.exists()) {
                            gameState.roomId = roomCode;
                            gameState.isHost = false;
                            showScreen('room-setup');
                        } else {
                            alert('Room not found. Please check the room code.');
                        }
                    });
                } else {
                    gameState.roomId = roomCode;
                    gameState.isHost = false;
                    showScreen('room-setup');
                }
            } else {
                alert('Please enter a valid 4-character room code');
            }
        }

        function toggleAnonymous() {
            gameState.anonymousMode = !gameState.anonymousMode;
            const toggle = event.target;
            toggle.classList.toggle('on');
        }

        function startRoom() {
            const nameInput = document.getElementById('player-name');
            if (!nameInput.value.trim()) {
                alert('Please enter your name');
                return;
            }
            
            gameState.playerName = nameInput.value.trim();
            
            if (gameState.isHost) {
                // Host creates new room
                const modeSelect = document.getElementById('mode-select');
                const modes = { quick: 5, standard: 10, epic: 20 };
                gameState.maxRounds = modes[modeSelect.value];
                
                gameState.participants = [gameState.playerName];
                gameState.scores = {};
                gameState.scores[gameState.playerName] = 0;
                gameState.currentPhase = 'waiting';
                
                saveRoomState();
            } else {
                // Player joins existing room
                if (db) {
                    db.ref('rooms/' + gameState.roomId).once('value').then((snapshot) => {
                        const roomData = snapshot.val();
                        if (roomData) {
                            if (!roomData.participants.includes(gameState.playerName)) {
                                roomData.participants.push(gameState.playerName);
                                roomData.scores = roomData.scores || {};
                                roomData.scores[gameState.playerName] = 0;
                                
                                gameState = {
                                    ...roomData,
                                    submittedSentences: new Set(roomData.submittedSentences || []),
                                    votedParticipants: new Set(roomData.votedParticipants || []),
                                    playerName: gameState.playerName,
                                    isHost: false
                                };
                                
                                saveRoomState();
                            }
                        }
                    });
                }
            }
            
            showScreen('game-room');
            updateUI();
            updateScoreboard();
            
            if (db) {
                listenToRoom(gameState.roomId);
            }
        }

        function startWriting() {
            if (gameState.participants.length < 3) {
                alert('Need at least 3 participants to start writing');
                return;
            }
            if (!gameState.isHost) return;
            
            gameState.currentPhase = 'writing';
            gameState.sentences = [];
            gameState.submittedSentences.clear();
            gameState.votingOptions = [];
            gameState.selectedOption = null;
            
            updateGamePhaseUI();
            updateUI();
            saveRoomState();
            
            // Focus on the appropriate input field
            const sentenceInput = document.getElementById('sentence-input');
            const sentenceInputMain = document.getElementById('sentence-input-main');
            
            if (sentenceInputMain && !sentenceInputMain.classList.contains('hidden')) {
                sentenceInputMain.focus();
            } else if (sentenceInput) {
                sentenceInput.focus();
            }
        }

        function submitSentence() {
            const input = document.getElementById('sentence-input');
            const inputMain = document.getElementById('sentence-input-main');
            const sentence = (inputMain && inputMain.value.trim()) || (input && input.value.trim()) || '';
            
            if (!sentence) {
                alert('Please write a sentence before submitting');
                return;
            }
            
            if (gameState.submittedSentences.has(gameState.playerName)) {
                alert('You have already submitted a sentence for this round');
                return;
            }
            
            // Add sentence to local state first
            gameState.sentences = gameState.sentences || [];
            gameState.sentences.push({
                text: sentence,
                author: gameState.playerName,
                votes: 0
            });
            
            gameState.submittedSentences.add(gameState.playerName);
            
            // Clear both input fields
            if (input) input.value = '';
            if (inputMain) inputMain.value = '';
            
            // Save to Firebase immediately
            saveRoomState();
            
            // Update UI to show submission
            updateUI();
            
            // Check if all participants have submitted (use setTimeout to ensure Firebase sync)
            setTimeout(() => {
                if (gameState.submittedSentences.size === gameState.participants.length) {
                    startVotingPhase();
                } else {
                    const phaseText = `Waiting for ${gameState.participants.length - gameState.submittedSentences.size} more participants...`;
                    const phaseIndicator = document.getElementById('phase-indicator');
                    const phaseIndicatorMain = document.getElementById('phase-indicator-main');
                    if (phaseIndicator) phaseIndicator.textContent = phaseText;
                    if (phaseIndicatorMain) phaseIndicatorMain.textContent = phaseText;
                    
                    document.getElementById('writing-phase').classList.add('hidden');
                    const writingPhaseMain = document.getElementById('writing-phase-main');
                    if (writingPhaseMain) writingPhaseMain.classList.add('hidden');
                }
            }, 100);
        }

        function startVotingPhase() {
            gameState.currentPhase = 'voting';
            gameState.selectedOption = null;
            gameState.votedParticipants.clear();
            
            gameState.votingOptions = [...gameState.sentences].sort(() => Math.random() - 0.5);
            
            // Don't create voting elements here - let updateGamePhaseUI() handle it
            updateGamePhaseUI();
            saveRoomState();
        }

        function voteForOption(index) {
            if (gameState.selectedOption !== null) return;
            if (gameState.votingOptions[index].author === gameState.playerName) {
                alert("You cannot vote for your own sentence");
                return;
            }
            
            gameState.selectedOption = index;
            gameState.votingOptions[index].votes = (gameState.votingOptions[index].votes || 0) + 1;
            gameState.votedParticipants.add(gameState.playerName);
            
            // Update UI for both old and new interfaces
            document.querySelectorAll('.option').forEach((el, i) => {
                if (i === index) {
                    el.classList.add('selected');
                }
                el.style.pointerEvents = 'none';
            });
            
            document.querySelectorAll('.main-option').forEach((el, i) => {
                if (i === index) {
                    el.classList.add('selected');
                }
                el.style.pointerEvents = 'none';
            });
            
            // Update vote count displays
            const voteCountEl = document.getElementById(`vote-count-${index}`);
            const mainVoteCountEl = document.getElementById(`main-vote-count-${index}`);
            const votes = gameState.votingOptions[index].votes;
            
            if (voteCountEl) voteCountEl.textContent = `${votes} votes`;
            if (mainVoteCountEl) mainVoteCountEl.textContent = `${votes} votes`;
            
            const waitingText = `Waiting for ${gameState.participants.length - gameState.votedParticipants.size} more votes...`;
            const phaseIndicator = document.getElementById('phase-indicator');
            const phaseIndicatorMain = document.getElementById('phase-indicator-main');
            
            if (phaseIndicator) phaseIndicator.textContent = waitingText;
            if (phaseIndicatorMain) phaseIndicatorMain.textContent = waitingText;
            
            // Save to Firebase
            saveRoomState();
            
            // Check if everyone voted (with timeout to ensure Firebase sync)
            setTimeout(() => {
                if (gameState.votedParticipants.size === gameState.participants.length) {
                    showResults();
                }
            }, 100);
        }

        function showResults() {
            const winner = gameState.votingOptions.reduce((prev, current) => 
                ((prev.votes || 0) > (current.votes || 0)) ? prev : current
            );
            
            if (gameState.scores[winner.author] !== undefined) {
                gameState.scores[winner.author] += (winner.votes || 0);
            }
            
            if (gameState.currentParagraph) {
                gameState.currentParagraph += ' ' + winner.text;
            } else {
                gameState.currentParagraph = winner.text;
            }
            
            // Update both paragraph displays
            const paragraphEl = document.getElementById('current-paragraph');
            const paragraphMainEl = document.getElementById('current-paragraph-main');
            
            if (paragraphEl) paragraphEl.textContent = gameState.currentParagraph;
            if (paragraphMainEl) paragraphMainEl.textContent = gameState.currentParagraph;
            
            gameState.round++;
            updateScoreboard();
            
            if (gameState.round > gameState.maxRounds) {
                saveParagraph();
                startNewParagraph();
            } else {
                // Reset for next round
                gameState.currentPhase = 'waiting';
                gameState.sentences = [];
                gameState.submittedSentences.clear();
                gameState.votedParticipants.clear();
                gameState.votingOptions = [];
                gameState.selectedOption = null;
                
                saveRoomState();
                updateUI();
                
                setTimeout(() => {
                    if (gameState.isHost) {
                        startWriting();
                    }
                }, 2000);
            }
        }

        function saveParagraph() {
            // Count how many sentences each author contributed
            const authorContributions = {};
            gameState.participants.forEach(p => authorContributions[p] = 0);
            
            // Go through the saved voting results to count actual contributions
            // For now, use scores as approximation of contributions
            const contributors = Object.entries(gameState.scores)
                .filter(([name, score]) => score > 0)
                .map(([name, score]) => `${name} (${Math.round(score/gameState.participants.length)} sentences)`)
                .sort();
            
            const paragraph = {
                text: gameState.currentParagraph,
                roomId: gameState.roomId,
                contributors: contributors.length > 0 ? contributors : gameState.participants,
                timestamp: new Date().toLocaleString(),
                finalScores: { ...gameState.scores },
                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            };
            
            // Save to local storage (backup)
            completedParagraphs.push(paragraph);
            localStorage.setItem('paragraphs', JSON.stringify(completedParagraphs));
            
            // Save to Firebase (global storage)
            if (db && connected) {
                db.ref('completedParagraphs/' + paragraph.id).set(paragraph);
            }
        }

        function startNewParagraph() {
            gameState.currentParagraph = '';
            gameState.round = 1;
            gameState.sentences = [];
            gameState.submittedSentences.clear();
            gameState.votedParticipants.clear();
            gameState.votingOptions = [];
            gameState.selectedOption = null;
            gameState.currentPhase = 'waiting';
            
            const phaseText = 'Paragraph saved! Starting new paragraph...';
            const phaseIndicator = document.getElementById('phase-indicator');
            const phaseIndicatorMain = document.getElementById('phase-indicator-main');
            
            if (phaseIndicator) phaseIndicator.textContent = phaseText;
            if (phaseIndicatorMain) phaseIndicatorMain.textContent = phaseText;
            
            document.getElementById('writing-phase').classList.add('hidden');
            document.getElementById('voting-phase').classList.add('hidden');
            
            const writingPhaseMain = document.getElementById('writing-phase-main');
            const votingPhaseMain = document.getElementById('voting-phase-main');
            if (writingPhaseMain) writingPhaseMain.classList.add('hidden');
            if (votingPhaseMain) votingPhaseMain.classList.add('hidden');
            
            updateUI();
            saveRoomState();
            
            setTimeout(() => {
                if (gameState.isHost) {
                    startWriting();
                }
            }, 2000);
        }

        function leaveRoom() {
            if (confirm('Are you sure you want to leave this room?')) {
                if (roomRef) {
                    roomRef.off();
                    roomRef = null;
                }
                showScreen('main-menu');
                loadCompletedParagraphs();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('main-menu');
            loadCompletedParagraphs();
        });

        // Handle Enter key in inputs
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (document.activeElement.id === 'room-code') {
                    joinRoom();
                } else if (document.activeElement.id === 'player-name') {
                    startRoom();
                } else if ((document.activeElement.id === 'sentence-input' || document.activeElement.id === 'sentence-input-main') && e.ctrlKey) {
                    submitSentence();
                }
            }
        });
    </script>
</body>
</html>
