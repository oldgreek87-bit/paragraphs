<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARAGRAPHS</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        function startWriting() {
            if (gameState.participants.length < 3) {
                alert('Need at least 3 participants to start writing');
                return;
            }
            if (!gameState.isHost) return;
            
            gameState.currentPhase = 'writing';
            gameState.sentences = [];
            gameState.submittedSentences.clear();
            gameState.votingOptions = [];
            gameState.selectedOption = null;
            
            updateGamePhaseUI();
            updateUI();
            saveRoomState();
        }

        function submitSentence() {
            const input = document.getElementById('sentence-input');
            const sentence = input.value.trim();
            
            if (!sentence) {
                alert('Please write a sentence before submitting');
                return;
            }
            
            if (gameState.submittedSentences.has(gameState.playerName)) {
                alert('You have already submitted a sentence for this round');
                return;
            }
            
            gameState.sentences = gameState.sentences || [];
            gameState.sentences.push({
                text: sentence,
                author: gameState.playerName,
                votes: 0
            });
            
            gameState.submittedSentences.add(gameState.playerName);
            input.value = '';
            
            saveRoomState();
            updateUI();
            
            setTimeout(() => {
                if (gameState.submittedSentences.size === gameState.participants.length) {
                    startVotingPhase();
                } else {
                    document.getElementById('phase-indicator').textContent = `Waiting for ${gameState.participants.length - gameState.submittedSentences.size} more participants...`;
                    document.getElementById('writing-phase').classList.add('hidden');
                }
            }, 100);
        }

        function startVotingPhase() {
            gameState.currentPhase = 'voting';
            gameState.selectedOption = null;
            gameState.votedParticipants.clear();
            
            gameState.votingOptions = [...gameState.sentences].sort(() => Math.random() - 0.5);
            
            updateGamePhaseUI();
            saveRoomState();
        }

        function voteForOption(index) {
            if (gameState.selectedOption !== null) return;
            if (gameState.votingOptions[index].author === gameState.playerName) {
                alert("You cannot vote for your own sentence");
                return;
            }
            
            gameState.selectedOption = index;
            gameState.votingOptions[index].votes = (gameState.votingOptions[index].votes || 0) + 1;
            gameState.votedParticipants.add(gameState.playerName);
            
            document.querySelectorAll('.option-zen').forEach((el, i) => {
                if (i === index) {
                    el.classList.add('selected');
                }
                el.style.pointerEvents = 'none';
            });
            
            const voteCountEl = document.getElementById(`vote-count-${index}`);
            if (voteCountEl) {
                voteCountEl.textContent = `${gameState.votingOptions[index].votes} votes`;
            }
            
            document.getElementById('phase-indicator').textContent = 
                `Waiting for ${gameState.participants.length - gameState.votedParticipants.size} more votes...`;
            
            saveRoomState();
            
            setTimeout(() => {
                if (gameState.votedParticipants.size === gameState.participants.length) {
                    showResults();
                }
            }, 100);
        }

        function showResults() {
            const winner = gameState.votingOptions.reduce((prev, current) => 
                ((prev.votes || 0) > (current.votes || 0)) ? prev : current
            );
            
            if (gameState.scores[winner.author] !== undefined) {
                gameState.scores[winner.author] += (winner.votes || 0);
            }
            
            if (gameState.currentParagraph) {
                gameState.currentParagraph += ' ' + winner.text;
            } else {
                gameState.currentParagraph = winner.text;
            }
            
            const currentText = gameState.currentParagraph;
            document.getElementById('current-paragraph').innerHTML = currentText + '<span class="typing-cursor"></span>';
            
            gameState.round++;
            updateScoreboard();
            
            if (gameState.round > gameState.maxRounds) {
                saveParagraph();
                startNewParagraph();
            } else {
                gameState.currentPhase = 'waiting';
                gameState.sentences = [];
                gameState.submittedSentences.clear();
                gameState.votedParticipants.clear();
                gameState.votingOptions = [];
                gameState.selectedOption = null;
                
                saveRoomState();
                updateUI();
                
                setTimeout(() => {
                    if (gameState.isHost) {
                        startWriting();
                    }
                }, 2000);
            }
        }

        function saveParagraph() {
            const authorContributions = {};
            gameState.participants.forEach(p => authorContributions[p] = 0);
            
            const contributors = Object.entries(gameState.scores)
                .filter(([name, score]) => score > 0)
                .map(([name, score]) => `${name} (${Math.round(score/gameState.participants.length)} sentences)`)
                .sort();
            
            const paragraph = {
                text: gameState.currentParagraph,
                roomId: gameState.roomId,
                contributors: contributors.length > 0 ? contributors : gameState.participants,
                timestamp: new Date().toLocaleString(),
                finalScores: { ...gameState.scores },
                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            };
            
            completedParagraphs.push(paragraph);
            localStorage.setItem('paragraphs', JSON.stringify(completedParagraphs));
            
            if (db && connected) {
                db.ref('completedParagraphs/' + paragraph.id).set(paragraph);
            }
        }

        function startNewParagraph() {
            gameState.currentParagraph = '';
            gameState.round = 1;
            gameState.sentences = [];
            gameState.submittedSentences.clear();
            gameState.votedParticipants.clear();
            gameState.votingOptions = [];
            gameState.selectedOption = null;
            gameState.currentPhase = 'waiting';
            
            document.getElementById('phase-indicator').textContent = 'Paragraph saved! Starting new paragraph...';
            document.getElementById('writing-phase').classList.add('hidden');
            document.getElementById('voting-phase').classList.add('hidden');
            
            updateUI();
            saveRoomState();
            
            setTimeout(() => {
                if (gameState.isHost) {
                    startWriting();
                }
            }, 2000);
        }

        function leaveRoom() {
            if (confirm('Are you sure you want to leave this room?')) {
                if (roomRef) {
                    roomRef.off();
                    roomRef = null;
                }
                showScreen('main-menu');
                loadCompletedParagraphs();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('main-menu');
            loadCompletedParagraphs();
        });

        // Handle Enter key in inputs
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (document.activeElement.id === 'room-code') {
                    joinRoom();
                } else if (document.activeElement.id === 'player-name') {
                    startRoom();
                } else if (document.activeElement.id === 'sentence-input' && e.ctrlKey) {
                    submitSentence();
                }
            }
        });
    </script>
</body>
</html>
        
        body {
            font-family: 'Courier Prime', monospace;
            background: #ffffff;
            color: #000000;
            line-height: 1.4;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* Main menu layout */
        .main-menu-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .main-menu-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .main-menu-controls {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #000;
            background: #fff;
        }
        
        /* Pinterest-style grid for paragraphs */
        .paragraphs-grid {
            columns: 3;
            column-gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 900px) {
            .paragraphs-grid {
                columns: 2;
            }
        }
        
        @media (max-width: 600px) {
            .paragraphs-grid {
                columns: 1;
            }
        }
        
        .paragraph-card {
            border: 2px solid #000;
            margin-bottom: 20px;
            padding: 15px;
            background: #fff;
            break-inside: avoid;
            page-break-inside: avoid;
        }
        
        .paragraph-card:hover {
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    #000 2px,
                    #000 3px
                );
            background-size: 8px 8px;
            opacity: 0.03;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            border: 2px solid #000;
            padding: 20px;
            background: 
                radial-gradient(circle at 25% 25%, #000 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, #000 1px, transparent 1px);
            background-size: 4px 4px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .btn {
            background: #000;
            color: #fff;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.1s;
        }
        
        .btn:hover {
            background: #fff;
            color: #000;
        }
        
        .btn:active {
            transform: translate(1px, 1px);
        }
        
        .room-settings {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #000;
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 1px,
                    #000 1px,
                    #000 2px
                );
            background-size: 10px 10px;
            opacity: 0.05;
        }
        
        .settings-row {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .toggle {
            width: 40px;
            height: 20px;
            border: 2px solid #000;
            background: #fff;
            position: relative;
            cursor: pointer;
        }
        
        .toggle.on {
            background: #000;
        }
        
        .toggle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #000;
            top: 0px;
            left: 0px;
            transition: left 0.2s;
        }
        
        .toggle.on::after {
            background: #fff;
            left: 20px;
        }
        
        .no-paragraphs {
            text-align: center;
            font-style: italic;
            opacity: 0.7;
            padding: 20px;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border: 1px solid #000;
            background: #fff;
            font-size: 12px;
            z-index: 1000;
        }

        .connection-status.connected {
            background: #000;
            color: #fff;
        }
        
        .hidden {
            display: none;
        }

        /* ===== ZEN GAME ROOM LAYOUT ===== */
        #game-room {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: #ffffff;
            display: grid;
            grid-template-areas: 
                "room-info . . . scoreboard"
                ". . paragraph . ."
                ". . phase . ."
                ". . input . .";
            grid-template-columns: 200px 1fr 3fr 1fr 200px;
            grid-template-rows: 80px 1fr auto 1fr;
            padding: 20px;
            gap: 20px;
        }

        /* Top corners info */
        .room-info-zen {
            grid-area: room-info;
            font-size: 11px;
            opacity: 0.5;
            padding: 10px 0;
        }

        .scoreboard-zen {
            grid-area: scoreboard;
            font-size: 11px;
            opacity: 0.5;
            text-align: right;
            padding: 10px 0;
        }

        /* Center content */
        .paragraph-zen {
            grid-area: paragraph;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .paragraph-content {
            font-size: 26px;
            line-height: 1.6;
            padding: 40px;
            border: 2px solid #000;
            background: #fff;
            min-height: 250px;
            max-width: 800px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .typing-cursor {
            display: inline-block;
            width: 3px;
            height: 30px;
            background: #000;
            animation: blink 1s infinite;
            margin-left: 4px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .phase-zen {
            grid-area: phase;
            text-align: center;
            font-size: 14px;
            opacity: 0.7;
            padding: 15px;
            border-top: 1px solid #000;
            border-bottom: 1px solid #000;
        }

        .input-zen {
            grid-area: input;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Zen text input */
        .text-zen {
            width: 100%;
            max-width: 900px;
            padding: 20px;
            border: none;
            border-bottom: 4px solid #000;
            font-family: inherit;
            font-size: 32px;
            background: transparent;
            text-align: center;
            outline: none;
            line-height: 1.2;
        }

        .text-zen::placeholder {
            color: #999;
            font-style: italic;
        }

        /* Zen voting */
        .voting-zen {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            width: 100%;
            max-width: 1000px;
        }

        .option-zen {
            border: 2px solid #000;
            padding: 25px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1.5;
            background: #fff;
            text-align: center;
            transition: all 0.2s;
            position: relative;
        }

        .option-zen:hover {
            background: #f5f5f5;
        }

        .option-zen.selected {
            background: #000;
            color: #fff;
        }

        .option-label-zen {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            display: block;
        }

        .vote-count-zen {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 11px;
            opacity: 0.6;
        }

        /* Side elements */
        .participants-zen {
            position: fixed;
            left: 20px;
            bottom: 20px;
            font-size: 10px;
            opacity: 0.4;
            max-width: 150px;
            z-index: 100;
        }

        .participant-zen {
            margin: 1px 0;
        }

        .participant-zen.ready {
            font-weight: bold;
            opacity: 0.8;
        }

        .controls-zen {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        .btn-zen {
            background: #000;
            color: #fff;
            border: 1px solid #000;
            padding: 6px 12px;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            margin-left: 8px;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .btn-zen:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">Connecting...</div>
    
    <div class="container">
        <!-- Main Menu -->
        <div id="main-menu" class="screen">
            <div class="main-menu-container">
                <div class="main-menu-header">
                    <div class="header">
                        <div class="logo">P A R A G R A P H S</div>
                        <div class="subtitle">Collaborative Writing Tool</div>
                    </div>
                </div>
                
                <div class="main-menu-controls">
                    <button class="btn" onclick="createRoom()">CREATE ROOM</button>
                    <input type="text" id="room-code" placeholder="Enter room code..." style="margin: 10px; padding: 8px; border: 2px solid #000; font-family: inherit;">
                    <button class="btn" onclick="joinRoom()">JOIN ROOM</button>
                </div>
                
                <div style="flex-grow: 1;">
                    <div style="text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #000; padding-bottom: 10px;">COMPLETED PARAGRAPHS</div>
                    <div id="completed-paragraphs" class="paragraphs-grid">
                        <!-- Completed paragraphs will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Room Setup -->
        <div id="room-setup" class="screen hidden">
            <div class="header">
                <div class="logo">ROOM SETUP</div>
            </div>
            
            <div class="room-settings">
                <div class="settings-row">
                    <span>Mode:</span>
                    <select id="mode-select" style="border: 2px solid #000; padding: 5px; font-family: inherit;">
                        <option value="quick">Quick (5 sentences)</option>
                        <option value="standard" selected>Standard (10 sentences)</option>
                        <option value="epic">Epic (20 sentences)</option>
                    </select>
                </div>
                
                <div class="settings-row">
                    <span>Anonymous mode:</span>
                    <div class="toggle" onclick="toggleAnonymous()"></div>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <input type="text" id="player-name" placeholder="Enter your name..." style="width: 100%; padding: 10px; border: 2px solid #000; font-family: inherit; margin-bottom: 10px;">
                <div style="text-align: center;">
                    <button class="btn" onclick="startRoom()">JOIN ROOM</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ZEN GAME ROOM - completely separate from container -->
    <div id="game-room" class="screen hidden">
        <!-- Room info (top left) -->
        <div class="room-info-zen">
            Room <span id="room-id">XXXX</span><br>
            Round <span id="round-number">1</span>/<span id="max-rounds">10</span>
        </div>

        <!-- Scoreboard (top right) -->
        <div class="scoreboard-zen">
            <div id="scoreboard-content">
                <!-- Scores -->
            </div>
        </div>

        <!-- Main paragraph (center) -->
        <div class="paragraph-zen">
            <div class="paragraph-content" id="current-paragraph">
                Share room code with participants. Need at least 3 people to start.<span class="typing-cursor"></span>
            </div>
        </div>

        <!-- Phase indicator -->
        <div class="phase-zen" id="phase-indicator">
            Share room code with participants. Need at least 3 people to start.
        </div>

        <!-- Input area -->
        <div class="input-zen">
            <!-- Writing Phase -->
            <div id="writing-phase" class="hidden">
                <input type="text" class="text-zen" id="sentence-input" placeholder="Write your sentence here...">
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="submitSentence()">SUBMIT</button>
                </div>
            </div>
            
            <!-- Voting Phase -->
            <div id="voting-phase" class="hidden">
                <div class="voting-zen" id="voting-options">
                    <!-- Options will be populated here -->
                </div>
            </div>
        </div>

        <!-- Participants (bottom left) -->
        <div class="participants-zen">
            <div style="font-weight: bold; margin-bottom: 3px;">Participants (<span id="participant-count">1</span>):</div>
            <div id="participants-list">
                <!-- Participants -->
            </div>
        </div>

        <!-- Controls (bottom right) -->
        <div class="controls-zen">
            <button class="btn-zen" id="start-btn" onclick="startWriting()" style="display: none;">START</button>
            <button class="btn-zen" onclick="leaveRoom()">LEAVE</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database-compat.min.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCq0zaZKpWj1cWmiu-pqiHo4MuLmA9xZkc",
            authDomain: "paragraphs-e9d60.firebaseapp.com",
            databaseURL: "https://paragraphs-e9d60-default-rtdb.firebaseio.com/",
            projectId: "paragraphs-e9d60",
            storageBucket: "paragraphs-e9d60.firebasestorage.app",
            messagingSenderId: "116355067615",
            appId: "1:116355067615:web:52288095ad38472545836a",
            measurementId: "G-FHQWN8GYML"
        };

        // Initialize Firebase
        let db;
        let connected = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            
            // Connection status
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', (snapshot) => {
                connected = snapshot.val();
                const statusEl = document.getElementById('connection-status');
                if (connected) {
                    statusEl.textContent = 'Connected';
                    statusEl.classList.add('connected');
                } else {
                    statusEl.textContent = 'Disconnected';
                    statusEl.classList.remove('connected');
                }
            });
        } catch (error) {
            document.getElementById('connection-status').textContent = 'Error';
        }

        // Game state
        let gameState = {
            roomId: null,
            playerName: '',
            currentPhase: 'waiting',
            participants: [],
            currentParagraph: '',
            sentences: [],
            votingOptions: [],
            selectedOption: null,
            round: 1,
            maxRounds: 10,
            anonymousMode: false,
            scores: {},
            submittedSentences: new Set(),
            votedParticipants: new Set(),
            isHost: false
        };

        let roomRef = null;
        let completedParagraphs = JSON.parse(localStorage.getItem('paragraphs') || '[]');

        // Utility functions
        function generateRoomId() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function updateUI() {
            document.getElementById('room-id').textContent = gameState.roomId || 'XXXX';
            document.getElementById('participant-count').textContent = gameState.participants.length;
            document.getElementById('round-number').textContent = gameState.round;
            document.getElementById('max-rounds').textContent = gameState.maxRounds;
            
            // Update main paragraph display
            const currentText = gameState.currentParagraph || 'Share room code with participants. Need at least 3 people to start.';
            document.getElementById('current-paragraph').innerHTML = currentText + '<span class="typing-cursor"></span>';
            
            // Update participants list
            const participantsList = document.getElementById('participants-list');
            participantsList.innerHTML = gameState.participants.map(p => {
                const hasSubmitted = gameState.submittedSentences.has(p);
                return `<div class="participant-zen${hasSubmitted ? ' ready' : ''}">${p}</div>`;
            }).join('');
            
            // Update phase indicator and start button
            const startBtn = document.getElementById('start-btn');
            if (gameState.currentPhase === 'waiting') {
                if (gameState.participants.length < 3) {
                    document.getElementById('phase-indicator').textContent = `Share room code: ${gameState.roomId} - Need ${3 - gameState.participants.length} more participant(s)`;
                    startBtn.style.display = 'none';
                } else if (gameState.isHost) {
                    document.getElementById('phase-indicator').textContent = `${gameState.participants.length} participants ready. Click START when ready.`;
                    startBtn.style.display = 'inline-block';
                } else {
                    document.getElementById('phase-indicator').textContent = `Waiting for host to start the game...`;
                    startBtn.style.display = 'none';
                }
            } else {
                startBtn.style.display = 'none';
            }
        }

        function updateScoreboard() {
            const scoreboardContent = document.getElementById('scoreboard-content');
            const scoreboardHtml = Object.entries(gameState.scores || {})
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3)
                .map(([player, score]) => `<div>${player}: ${score}</div>`)
                .join('');
            
            scoreboardContent.innerHTML = scoreboardHtml || 'No scores';
        }

        function updateGamePhaseUI() {
            if (gameState.currentPhase === 'writing') {
                document.getElementById('writing-phase').classList.remove('hidden');
                document.getElementById('voting-phase').classList.add('hidden');
                document.getElementById('phase-indicator').textContent = `Round ${gameState.round}: Write the next sentence`;
                
                setTimeout(() => {
                    document.getElementById('sentence-input').focus();
                }, 100);
            } else if (gameState.currentPhase === 'voting') {
                document.getElementById('writing-phase').classList.add('hidden');
                document.getElementById('voting-phase').classList.remove('hidden');
                document.getElementById('phase-indicator').textContent = 'Vote for the best sentence';
                
                // Rebuild voting options
                const votingContainer = document.getElementById('voting-options');
                if (gameState.votingOptions && gameState.votingOptions.length > 0) {
                    votingContainer.innerHTML = gameState.votingOptions.map((option, index) => `
                        <div class="option-zen${gameState.selectedOption === index ? ' selected' : ''}" onclick="voteForOption(${index})">
                            <span class="option-label-zen">Option ${String.fromCharCode(65 + index)}</span>
                            <div>${option.text}</div>
                            <div class="vote-count-zen" id="vote-count-${index}">${option.votes || 0} votes</div>
                        </div>
                    `).join('');
                }
            } else {
                document.getElementById('writing-phase').classList.add('hidden');
                document.getElementById('voting-phase').classList.add('hidden');
            }
        }

        function saveRoomState() {
            if (!db || !gameState.roomId) return;
            
            const roomData = {
                ...gameState,
                submittedSentences: Array.from(gameState.submittedSentences),
                votedParticipants: Array.from(gameState.votedParticipants),
                lastUpdate: Date.now()
            };
            
            db.ref('rooms/' + gameState.roomId).set(roomData).catch(error => {
                // Silent error handling
            });
        }

        function listenToRoom(roomId) {
            if (!db) return;
            
            roomRef = db.ref('rooms/' + roomId);
            roomRef.on('value', (snapshot) => {
                const roomData = snapshot.val();
                if (roomData) {
                    const wasHost = gameState.isHost;
                    const playerName = gameState.playerName;
                    const currentSelectedOption = gameState.selectedOption;
                    
                    gameState = {
                        ...roomData,
                        submittedSentences: new Set(roomData.submittedSentences || []),
                        votedParticipants: new Set(roomData.votedParticipants || []),
                        isHost: wasHost,
                        playerName: playerName,
                        selectedOption: gameState.votedParticipants.has(playerName) ? currentSelectedOption : null
                    };
                    
                    updateUI();
                    updateScoreboard();
                    updateGamePhaseUI();
                }
            });
        }

        function displayCompletedParagraphs() {
            const container = document.getElementById('completed-paragraphs');
            if (completedParagraphs.length === 0) {
                container.innerHTML = '<div class="no-paragraphs">No paragraphs completed yet. Create a room to start writing!</div>';
                return;
            }
            
            container.innerHTML = completedParagraphs
                .slice()
                .reverse()
                .map((para, index) => `
                    <div class="paragraph-card">
                        <div class="paragraph-header">
                            #${completedParagraphs.length - index} | ${para.roomId}
                        </div>
                        <div style="font-size: 14px; line-height: 1.5; margin: 10px 0;">${para.text}</div>
                        <div class="paragraph-contributors">
                            ${para.timestamp}<br>
                            ${para.contributors.join(', ')}
                        </div>
                    </div>
                `).join('');
        }

        function loadCompletedParagraphs() {
            if (!db) {
                displayCompletedParagraphs();
                return;
            }
            
            db.ref('completedParagraphs').once('value').then((snapshot) => {
                const firebaseParagraphs = snapshot.val();
                if (firebaseParagraphs) {
                    const paragraphsArray = Object.values(firebaseParagraphs)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    const localParagraphs = JSON.parse(localStorage.getItem('paragraphs') || '[]');
                    const allParagraphs = [...paragraphsArray];
                    
                    localParagraphs.forEach(localPara => {
                        if (!paragraphsArray.find(fbPara => fbPara.id === localPara.id)) {
                            allParagraphs.push(localPara);
                        }
                    });
                    
                    completedParagraphs = allParagraphs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    localStorage.setItem('paragraphs', JSON.stringify(completedParagraphs));
                } else {
                    completedParagraphs = JSON.parse(localStorage.getItem('paragraphs') || '[]');
                }
                
                displayCompletedParagraphs();
            }).catch(error => {
                completedParagraphs = JSON.parse(localStorage.getItem('paragraphs') || '[]');
                displayCompletedParagraphs();
            });
        }

        // Main functions
        function createRoom() {
            gameState.roomId = generateRoomId();
            gameState.isHost = true;
            showScreen('room-setup');
        }

        function joinRoom() {
            const roomCode = document.getElementById('room-code').value.toUpperCase();
            if (roomCode.length === 4) {
                if (db) {
                    db.ref('rooms/' + roomCode).once('value').then((snapshot) => {
                        if (snapshot.exists()) {
                            gameState.roomId = roomCode;
                            gameState.isHost = false;
                            showScreen('room-setup');
                        } else {
                            alert('Room not found. Please check the room code.');
                        }
                    });
                } else {
                    gameState.roomId = roomCode;
                    gameState.isHost = false;
                    showScreen('room-setup');
                }
            } else {
                alert('Please enter a valid 4-character room code');
            }
        }

        function toggleAnonymous() {
            gameState.anonymousMode = !gameState.anonymousMode;
            const toggle = event.target;
            toggle.classList.toggle('on');
        }

        function startRoom() {
            const nameInput = document.getElementById('player-name');
            if (!nameInput.value.trim()) {
                alert('Please enter your name');
                return;
            }
            
            gameState.playerName = nameInput.value.trim();
            
            if (gameState.isHost) {
                const modeSelect = document.getElementById('mode-select');
                const modes = { quick: 5, standard: 10, epic: 20 };
                gameState.maxRounds = modes[modeSelect.value];
                
                gameState.participants = [gameState.playerName];
                gameState.scores = {};
                gameState.scores[gameState.playerName] = 0;
                gameState.currentPhase = 'waiting';
                
                saveRoomState();
            } else {
                if (db) {
                    db.ref('rooms/' + gameState.roomId).once('value').then((snapshot) => {
                        const roomData = snapshot.val();
                        if (roomData) {
                            if (!roomData.participants.includes(gameState.playerName)) {
                                roomData.participants.push(gameState.playerName);
                                roomData.scores = roomData.scores || {};
                                roomData.scores[gameState.playerName] = 0;
                                
                                gameState = {
                                    ...roomData,
                                    submittedSentences: new Set(roomData.submittedSentences || []),
                                    votedParticipants: new Set(roomData.votedParticipants || []),
                                    playerName: gameState.playerName,
                                    isHost: false
                                };
                                
                                saveRoomState();
                            }
                        }
                    });
                }
            }
            
            showScreen('game-room');
            updateUI();
            updateScoreboard();
            
            if (db) {
                listenToRoom(gameState.roomId);
            }
