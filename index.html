<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PARAGRAPHS Game</title>
  <style>
    body { font-family: sans-serif; background: #f8f8f8; padding: 20px; }
    .screen { display: none; }
    .visible { display: block; }
    button { margin: 5px; padding: 8px 12px; cursor: pointer; }
    #story { white-space: pre-wrap; margin: 10px 0; padding: 10px; background: #fff; border: 1px solid #ccc; }
    .option { padding: 8px; margin: 4px 0; border: 1px solid #aaa; cursor: pointer; background: #eee; }
    .option:hover { background: #ddd; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

  <h1>üìñ PARAGRAPHS</h1>

  <!-- Start Screen -->
  <div id="start-screen" class="screen visible">
    <input id="player-name" placeholder="Your name">
    <input id="room-id" placeholder="Room ID">
    <button onclick="createRoom()">Create Room</button>
    <button onclick="joinRoom()">Join Room</button>
  </div>

  <!-- Game Screen -->
  <div id="game-room" class="screen">
    <h2>Room: <span id="room-label"></span></h2>
    <h3>Players:</h3>
    <ul id="players"></ul>

    <div id="phase-waiting" class="phase">‚è≥ Waiting for players...</div>

    <div id="phase-writing" class="phase">
      <h3>Write your sentence:</h3>
      <textarea id="sentence-input" rows="2" cols="50"></textarea><br>
      <button onclick="submitSentence()">Submit</button>
    </div>

    <div id="phase-voting" class="phase">
      <h3>Vote for the best next sentence:</h3>
      <div id="options"></div>
    </div>

    <div id="phase-finished" class="phase">
      <h3>Final Story:</h3>
      <div id="story"></div>
    </div>

    <h3>Story so far:</h3>
    <div id="story"></div>
  </div>

<script>
  // === Firebase config ===
  const firebaseConfig = {
    apiKey: "AIzaSyCq0zaZKpWj1cWmiu-pqiHo4MuLmA9xZkc",
    authDomain: "paragraphs-e9d60.firebaseapp.com",
    databaseURL: "https://paragraphs-e9d60-default-rtdb.firebaseio.com",
    projectId: "paragraphs-e9d60",
    storageBucket: "paragraphs-e9d60.firebasestorage.app",
    messagingSenderId: "116355067615",
    appId: "1:116355067615:web:52288095ad38472545836a",
    measurementId: "G-FHQWN8GYML"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // === Game state ===
  let gameState = {
    playerName: "",
    roomId: "",
    isHost: false,
    participants: [],
    currentPhase: "waiting",
    currentParagraph: "",
    round: 1,
    maxRounds: 5,
    submittedSentences: [],
    votingOptions: [],
    votedParticipants: []
  };

  // === UI helpers ===
  function showScreen(id) {
    document.querySelectorAll(".screen").forEach(s => s.classList.remove("visible"));
    document.getElementById(id).classList.add("visible");
  }
  function showPhase(phase) {
    document.querySelectorAll(".phase").forEach(p => p.style.display = "none");
    document.getElementById("phase-" + phase).style.display = "block";
  }

  // === Room creation ===
  function createRoom() {
    const roomId = document.getElementById("room-id").value.trim() || Math.random().toString(36).substring(2,6);
    const playerName = document.getElementById("player-name").value.trim() || "Anonymous";
    gameState.roomId = roomId;
    gameState.playerName = playerName;
    gameState.isHost = true;

    db.ref("rooms/" + roomId).set({
      participants: [playerName],
      currentPhase: "waiting",
      currentParagraph: "",
      round: 1,
      maxRounds: 5,
      submittedSentences: [],
      votingOptions: [],
      votedParticipants: []
    });

    joinRoomCommon();
  }

  function joinRoom() {
    gameState.roomId = document.getElementById("room-id").value.trim();
    gameState.playerName = document.getElementById("player-name").value.trim() || "Anonymous";
    joinRoomCommon();
  }

  function joinRoomCommon() {
    const participantsRef = db.ref(`rooms/${gameState.roomId}/participants`);
    participantsRef.once("value").then(snapshot => {
      let participants = snapshot.val() || [];
      if (!participants.includes(gameState.playerName)) {
        participants.push(gameState.playerName);
        participantsRef.set(participants);
      }
    });

    listenToRoom(gameState.roomId);
    document.getElementById("room-label").textContent = gameState.roomId;
    showScreen("game-room");
  }

  // === Room listener ===
  function listenToRoom(roomId) {
    db.ref("rooms/" + roomId).on("value", snapshot => {
      const data = snapshot.val();
      if (!data) return;
      gameState = {...gameState, ...data};

      // Update players list
      document.getElementById("players").innerHTML = gameState.participants.map(p => `<li>${p}</li>`).join("");

      // Update story
      document.querySelectorAll("#story").forEach(el => el.textContent = gameState.currentParagraph);

      // Switch phase
      showPhase(gameState.currentPhase);

      if (gameState.isHost) {
        if (gameState.currentPhase === "waiting" && gameState.participants.length >= 2) {
          startWriting();
        }
        if (gameState.currentPhase === "writing") checkIfAllSubmitted();
        if (gameState.currentPhase === "voting") checkIfVotingComplete();
      }

      // Voting options
      if (gameState.currentPhase === "voting") {
        document.getElementById("options").innerHTML = "";
        (gameState.votingOptions || []).forEach((opt, i) => {
          const div = document.createElement("div");
          div.className = "option";
          div.textContent = opt.text + ` (${opt.votes||0} votes)`;
          div.onclick = () => voteForOption(i);
          document.getElementById("options").appendChild(div);
        });
      }
    });
  }

  // === Phase control (host only) ===
  function startWriting() {
    db.ref("rooms/" + gameState.roomId).update({
      currentPhase: "writing",
      submittedSentences: [],
      votingOptions: [],
      votedParticipants: []
    });
  }

  function checkIfAllSubmitted() {
    if (gameState.submittedSentences.length === gameState.participants.length) {
      db.ref("rooms/" + gameState.roomId).update({ currentPhase: "voting" });
    }
  }

  function checkIfVotingComplete() {
    if (gameState.votedParticipants.length === gameState.participants.length) {
      let winner = {text: "", votes: -1};
      (gameState.votingOptions || []).forEach(opt => {
        if ((opt.votes||0) > winner.votes) winner = opt;
      });
      const newText = gameState.currentParagraph + (gameState.currentParagraph ? " " : "") + winner.text;
      const nextRound = gameState.round + 1;
      const nextPhase = (nextRound > gameState.maxRounds) ? "finished" : "writing";

      db.ref("rooms/" + gameState.roomId).update({
        currentParagraph: newText,
        round: nextRound,
        currentPhase: nextPhase,
        submittedSentences: [],
        votingOptions: [],
        votedParticipants: []
      });
    }
  }

  // === Writing and voting ===
  function submitSentence() {
    const sentence = document.getElementById("sentence-input").value.trim();
    if (!sentence) return;

    const updates = {};
    const newIndex = (gameState.votingOptions || []).length;
    updates[`rooms/${gameState.roomId}/votingOptions/${newIndex}`] = {text: sentence, author: gameState.playerName, votes: 0};
    updates[`rooms/${gameState.roomId}/submittedSentences`] = [...(gameState.submittedSentences||[]), gameState.playerName];
    db.ref().update(updates);

    document.getElementById("sentence-input").value = "";
  }

  function voteForOption(index) {
    if (gameState.votedParticipants.includes(gameState.playerName)) return;

    db.ref(`rooms/${gameState.roomId}/votingOptions/${index}/votes`).transaction(v => (v||0) + 1);
    db.ref(`rooms/${gameState.roomId}/votedParticipants`).set([...gameState.votedParticipants, gameState.playerName]);
  }
</script>
</body>
</html>
